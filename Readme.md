# BankingTransactions_SpringAOP

Данный проект — учебный пример реализации **банковской системы** с переводом средств между счетами и логированием времени выполнения методов с помощью **Spring AOP**.

Проект создан в рамках задания со звёздочкой, где основной упор сделан на:
1. Управление транзакциями (Spring Data JPA).
2. Логирование переводов (создание отдельной таблицы `Transaction`).
3. Подсчёт времени выполнения методов (через аспект `TimingAspect`).

---

## Задание

- Разработать систему **банковского учёта**, моделирующую перевод средств между счетами пользователей.
- Реализовать **управление транзакциями** при переводе средств (использовать `@Transactional`).
- Добавить **логирование** транзакций (какие переводы выполнялись).
- Реализовать **подсчёт времени** выполнения методов, связанных с переводом средств (через AOP).

---

## Технологический стек

- **Java 17**
- **Spring Boot 3.4.1**
    - spring-boot-starter-web
    - spring-boot-starter-data-jpa
    - spring-boot-starter-aop
- **H2** (база данных в памяти, для удобства тестирования)
- **Lombok** (генерация геттеров/сеттеров, конструктора)

---

## Структура проекта (основные компоненты)

### **models**
- `Account`: сущность счёта с полями `id`, `userName`, `balance`.
- `Transaction`: сущность перевода (транзакции) с полями `id`, `idSender`, `idReceiver`, `amount`, `timestamp`.

### **repositories**
- `AccountRepository`: наследует `JpaRepository<Account, Long>`, для операций CRUD над таблицей `accounts`.
- `TransactionRepository`: наследует `JpaRepository<Transaction, Long>`, для операций CRUD над таблицей `transactions`.

### **services**
- `AccountService`: бизнес-логика перевода денег, создание аккаунта, чтение списка аккаунтов.
- `TransactionService`: запись транзакций, чтение всех транзакций.

### **controllers**
- `TransactionController`: REST-эндпоинты для создания аккаунта, получения списка аккаунтов и переводов, а также выполнения перевода.

### **aspects**
- `TimingAspect`: аспект, перехватывающий методы, помеченные `@TrackTime`, чтобы замерить и вывести в лог **время выполнения**.
- `TrackTime`: своя аннотация, которой помечаются методы для профилирования.

### **dto**
- `CreateAccountRequest`: для создания нового аккаунта (передача имени пользователя и начального баланса).
- `TransferRequest`: для выполнения перевода (senderId, receiverId, amount).

---

## Как работает

1. При запуске Spring Boot стартует встроенный сервер Tomcat, а также в памяти поднимается база H2.
2. В `TimingAspect` с помощью аннотации `@Around` улавливаются вызовы методов, помеченных `@TrackTime`, замеряется время начала, вызывается целевой метод, и замеряется время завершения. Разница выводится в логи.
3. В `AccountService` метод `transferMoney` отмечен `@Transactional`. Это означает, что все изменения (`findById`, проверка баланса, `setBalance`) выполняются в одной транзакции. Если возникнет ошибка, транзакция будет откатана.
4. Запись деталей перевода (Transaction) происходит в `TransactionService`.

---

## Запуск проекта

1. Склонируйте (или скачайте) репозиторий к себе на машину.
2. Убедитесь, что у вас установлен **Java 17** (или совместимая версия).
3. Соберите проект:
    ```bash
    mvn clean install
    ```
Запустите приложение:
```bash
mvn spring-boot:run
```
По умолчанию приложение стартует на порту 8080.

Использование эндпоинтов
### 1. Создание аккаунта

POST http://localhost:8080/create-account
Body (JSON):
   ```json 
    {
      "userName": "user1",
      "balance": 10000
    }
   ```
Описание: Создаёт новый счёт (аккаунт) с именем пользователя и начальным балансом.
### 2. Получить все аккаунты

GET http://localhost:8080/accounts

Описание: Возвращает список всех аккаунтов в базе данных.
### 3. Получить все транзакции

GET http://localhost:8080/transactions

Описание: Возвращает список всех транзакций (переводов), которые были выполнены.
### 4. Перевести деньги

POST http://localhost:8080/transfer
Body (JSON):
  ```json 
  {
    "senderId": 1,
    "receiverId": 2,
    "amount": 500
  }
  ```
Описание: Переводит сумму amount со счёта пользователя senderId на счёт receiverId.
В случае успеха в таблицу transactions записывается новая запись с деталями перевода.

## Пример использования

### Создаём три аккаунта (по очереди):

POST /create-account

**Пример:** POST http://localhost:8080/create-account

В теле запроса (одна строка - один запрос):
```json 
{ "userName": "user1", "balance": 10000 }
```
```json
{ "userName": "user2", "balance": 20000 }
```     
```json
{ "userName": "user3", "balance": 30000 }
```
### Проверяем список аккаунтов (GET /accounts).
GET /accounts

**Пример:**
GET http://localhost:8080/accounts

### Делаем перевод:

POST /transfer

**Пример:** POST http://localhost:8080/transfer

В теле запроса:

```json 
{
  "senderId": 1,
  "receiverId": 2,
  "amount": 500
}
```
### Снова проверяем список аккаунтов или список транзакций, чтобы убедиться, что перевод прошёл успешно.
GET /accounts

**Пример:**
GET http://localhost:8080/accounts


## Частые вопросы / Возможные ошибки
### 1. Error: The given id must not be null

Обычно возникает, если в JSON вы передали неправильное имя поля (например, опечатка sendertId вместо senderId). Убедитесь, что ключи в JSON строго совпадают с полями TransferRequest.
### 2. Изменение баланса

Код в AccountService использует метод accountRepository.save(...) после изменения sender и receiver, чтобы обновить баланс в базе данных.
### 3. Логика проверки баланса

В случае недостаточного баланса выбрасывается исключение RuntimeException("Not enough balance"), что откатывает транзакцию.
Заключение

## ИТОГ
В проекте показано, как использовать Spring Boot + Spring Data JPA + Spring AOP для реализации:

* Транзакций (аннотация @Transactional).
* Перехвата методов и подсчёта времени выполнения (аннотация @Around в TimingAspect).
* Базовых CRUD операций (репозитории JpaRepository).

Данный репозиторий служит демо-примером для задания со звёздочкой, чтобы закрепить навыки работы с транзакциями и аспектами в Spring.